<html>
    <head>
      <script src="./gml2d.js" type="text/javascript"></script>
      <title>Convex Hull Inspector</title>
      <link rel="stylesheet" href="style.css"/>
    </head>
    <body onload="init()" onmouseup="dragend(event)" onmousemove="dragging(event)">
    <script type="text/javascript">
        var canvas;
        var context;
        var points;
        var poly;

        function init() {
            canvas = document.getElementById( "viewport" );
            context = canvas.getContext( '2d' );

            var POINTS_TO_PLOT = 50;
            points = [];
            for ( var i = 0; i < POINTS_TO_PLOT; i++ ) {
                points.push( new gml2d.Vec2( Math.random() * canvas.width, Math.random() * canvas.height ) );
            }

            computeHull( points )
            visualizePoly( poly );
            drawPoints( points );
        }

        function computeHull( points ) {
            poly = gml2d.ConvexHull( points );
        }

        function drawPoints( points ) {
            points.forEach( function( p ) {
                context.beginPath();
                context.arc( p.x, p.y, 2, 0, 2 * Math.PI, false );
                context.fillStyle = 'black';
                context.fill();
            } );
        }

        function visualizePoly( poly ) {
            context.beginPath();
            context.moveTo( poly.points[0].x, poly.points[0].y );
            context.lineWidth = 1;
            context.fillStyle = gml2d.convex( poly ) ? 'green' : 'red';

            for ( var i = 0; i < poly.points.length; i++ ) {
                var p = poly.points[ (i+1) % poly.points.length ];
                context.lineTo( p.x, p.y );
            }

            context.fill();
            context.stroke();
        }

        var dragtarget;
        var DRAG_HIT_DIST_THRESHOLD = 50;

        var _mousepos = new gml2d.Vec2( 0, 0 );
        function dragstart( e ) {
            var offset = getOffset( canvas );

            _mousepos.x = e.clientX - offset.x;
            _mousepos.y = e.clientY - offset.y;

            for ( var i = 0; i < points.length; i++ ) {
                var p = points[i];
                var d = gml2d.Vec2.squareDistance( _mousepos, p );
                if ( d < DRAG_HIT_DIST_THRESHOLD ) {
                    dragtarget = p;
                    break;
                }
            }
        }

        function dragging( e ) {
            if ( dragtarget == null ) return;

            e.preventDefault();

            var offset = getOffset( canvas );

            _mousepos.x = e.clientX - offset.x;
            _mousepos.y = e.clientY - offset.y;

            if ( dragtarget != null ) {
                dragtarget.x = Math.min( Math.max( 0, _mousepos.x ), canvas.width );
                dragtarget.y = Math.min( Math.max( 0, _mousepos.y ), canvas.height );
                context.clearRect( 0, 0, canvas.width, canvas.height );
                computeHull( points )
                visualizePoly( poly );
                drawPoints( points );
            }
        }

        function dragend( e ) {
            dragtarget = null;
        }

        function getOffset( elem ) {
            var left = 0;
            var top = 0;
            while( true ){
              left += elem.offsetLeft;
              top += elem.offsetTop;
              if( elem.offsetParent === null ) {
                  break;
              }
              elem = elem.offsetParent;
            }
            return { x:left, y:top };
        }
    </script>
    <div role="main" id="maincolumn">
      <div id="screen">
        <center>
        <canvas id="viewport" height="500" width="500" onmousedown="dragstart(event)" onmouseup="dragend(event)">
        </canvas>
        </center>
      </div>
    </div>
    </body>
</html>
